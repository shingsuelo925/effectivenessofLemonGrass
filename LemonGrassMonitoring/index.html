<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neutralizer Smart Monitoring</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .live-status { display: flex; justify-content: space-around; margin-bottom: 30px; background: #2c3e50; color: white; padding: 20px; border-radius: 10px; }
        .stat-box { text-align: center; }
        .stat-box h3 { margin: 0; font-size: 14px; opacity: 0.8; }
        .stat-box div { font-size: 28px; font-weight: bold; margin-top: 5px; }
        .controls { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px; }
        input[type="date"] { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 16px; }
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-load { background: #3498db; color: white; }
        .btn-load:hover { background: #2980b9; }
        .btn-export { background: #27ae60; color: white; }
        .btn-export:hover { background: #219150; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f1f1f1; color: #333; }
    </style>
</head>
<body>

<div class="container">
    <h1>Neutralizer Smart Monitoring</h1>

    <div class="live-status">
        <div class="stat-box">
            <h3>LIVE GAS</h3>
            <div id="liveGas">--%</div>
        </div>
        <div class="stat-box">
            <h3>LIVE WATER</h3>
            <div id="liveWater">--%</div>
        </div>
        <div class="stat-box">
            <h3>MIST STATUS</h3>
            <div id="liveMist">--</div>
        </div>
    </div>

    <div class="controls">
        <div>
            <label><b>View History:</b> </label>
            <input type="date" id="datePicker">
            <button class="btn-load" onclick="loadHistory()">Load Day Logs</button>
        </div>
        <button class="btn-export" onclick="exportToExcel()">Download Excel (.xlsx)</button>
    </div>

    <table id="historyTable">
        <thead>
            <tr>
                <th>Time</th>
                <th>Gas (%)</th>
                <th>Water (%)</th>
                <th>Mist Status</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="4" style="text-align:center">Select a date above to view records.</td></tr>
        </tbody>
    </table>
</div>

<script>
    // FIREBASE CONFIGURATION
    const firebaseConfig = {
        apiKey: "AIzaSyDJPSSmhjMlW39eVKnPbnwr32r8el3I5gM",
        authDomain: "neutralizersmartmonitoring.firebaseapp.com",
        databaseURL: "https://neutralizersmartmonitoring-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "neutralizersmartmonitoring",
        storageBucket: "neutralizersmartmonitoring.appspot.com",
    };

    firebase.initializeApp(firebaseConfig);
    const rtdb = firebase.database();
    const store = firebase.firestore();

    // Set Date Picker to Today by default
    window.onload = () => {
        document.getElementById('datePicker').value = new Date().toISOString().split('T')[0];
    };

    // Keep track of the last saved timestamp to prevent duplicate logs in a single second
    let lastLogTime = 0;

    // 1. REALTIME LISTENER (RTDB) + AUTO-SAVE BRIDGE
    rtdb.ref('sensor').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            // Update UI
            document.getElementById('liveGas').innerText = data.gas + "%";
            document.getElementById('liveWater').innerText = data.water + "%";
            
            // INVERT LOGIC for Live View: If backend says "ON", show "OFF"
            const displayMist = (data.mist === "ON") ? "OFF" : "ON";
            document.getElementById('liveMist').innerText = displayMist;
            
            // Gas alert color
            if(data.gas > 50) document.getElementById('liveGas').style.color = "#e74c3c";
            else document.getElementById('liveGas').style.color = "white";

            // --- AUTO-SAVE TO FIRESTORE (The "Free Plan" Bridge) ---
            const now = Date.now();
            // We only save a log if at least 5 seconds have passed (prevents overloading Firestore)
            if (now - lastLogTime > 5000) { 
                const dateString = new Date().toISOString().split('T')[0];
                
                store.collection('logs').add({
                    gas: data.gas,
                    water: data.water,
                    mist: displayMist, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    dateString: dateString 
                }).then(() => {
                    console.log("Log saved to history.");
                    lastLogTime = now;
                }).catch(err => console.error("Save Error:", err));
            }
        }
    });

    // 2. HISTORY DATA (Firestore)
    function loadHistory() {
        const date = document.getElementById('datePicker').value;
        const tbody = document.getElementById('tableBody');
        
        if (!date) return alert("Please select a date!");
        tbody.innerHTML = "<tr><td colspan='4' style='text-align:center'>Fetching history...</td></tr>";

        store.collection('logs')
            .where('dateString', '==', date)
            .get()
            .then((querySnapshot) => {
                tbody.innerHTML = "";
                if (querySnapshot.empty) {
                    tbody.innerHTML = "<tr><td colspan='4' style='text-align:center'>No records found for this date.</td></tr>";
                    return;
                }
                
                let docs = [];
                querySnapshot.forEach(doc => docs.push(doc.data()));
                
                // Sort by time (Newest first)
                docs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                docs.forEach((d) => {
                    const logTime = d.timestamp ? d.timestamp.toDate().toLocaleTimeString() : "N/A";
                    tbody.innerHTML += `<tr>
                        <td>${logTime}</td>
                        <td>${d.gas}%</td>
                        <td>${d.water}%</td>
                        <td>${d.mist}</td> 
                    </tr>`;
                });
            })
            .catch(err => {
                console.error("Firestore Error:", err);
                tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:red;'>Error. Check Firestore Rules.</td></tr>";
            });
    }

    // 3. EXCEL EXPORT
    function exportToExcel() {
        const table = document.getElementById("historyTable");
        const date = document.getElementById("datePicker").value || "Data";
        const wb = XLSX.utils.table_to_book(table, {sheet: "DailyLogs"});
        XLSX.writeFile(wb, `Neutralizer_Report_${date}.xlsx`);
    }
</script>
</body>
</html>